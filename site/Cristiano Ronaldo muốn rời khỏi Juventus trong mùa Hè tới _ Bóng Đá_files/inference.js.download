!function(){function e(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function n(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function t(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}function r(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&o(e,n)}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,n){return(o=Object.setPrototypeOf||function(e,n){return e.__proto__=n,e})(e,n)}function a(e,n,t){return(a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,n,t){var r=[null];r.push.apply(r,n);var i=new(Function.bind.apply(e,r));return t&&o(i,t.prototype),i}).apply(null,arguments)}function u(e){var n="function"==typeof Map?new Map:void 0;return(u=function(e){if(null===e||(t=e,-1===Function.toString.call(t).indexOf("[native code]")))return e;var t;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,r)}function r(){return a(e,arguments,i(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),o(r,e)})(e)}function s(e,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):n}function c(e,n,t){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,n,t){var r=function(e,n){for(;!Object.prototype.hasOwnProperty.call(e,n)&&null!==(e=i(e)););return e}(e,n);if(r){var o=Object.getOwnPropertyDescriptor(r,n);return o.get?o.get.call(t):o.value}})(e,n,t||e)}function f(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var l=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(u(Error)),h=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(u(Error)),p=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(u(Error)),d=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(p),m=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(p),g=function(n){function t(){return e(this,t),s(this,i(t).apply(this,arguments))}return r(t,n),t}(m);function y(e){if(!Array.isArray(e))throw new h("Provided argument must be an instance of Array.")}function v(e){return 1/(1+Math.exp(-e))}var w=Object.freeze({MULTIPLICATIVE_INTERACTION:"multiplication",EQUALITY:"equality",CLIPPING:"clipping",MINMAX_SCALING:"minmax_scaling"}),b=function(){function n(t){e(this,n),this.feature=t}return t(n,[{key:"transform",value:function(e){if(!(this.feature in e))throw new g("Unable to transform feature ".concat(this.feature,", missing input ").concat(this.feature,". \n                    Provided: ").concat(Object.keys(e),", Required: ").concat(this.dependencies));return e[this.feature]}},{key:"dependencies",get:function(){return[this.feature]}}]),n}(),_=function(n){function o(n,t){var r;return e(this,o),(r=s(this,i(o).call(this,n))).interactions=t,r}return r(o,n),t(o,[{key:"transform",value:function(e){for(var n=this,t=this.interactions.map((function(t){if(!(t in e))throw new g("Unable to transform feature ".concat(n.feature,", missing input ").concat(t,".\n                    Provided: ").concat(Object.keys(e),", Required: ").concat(n.dependencies));return e[t]})).sort((function(e,n){return n.length-e.length})),r=0;r<t.length-1;r++)if(1!==t[r].length&&t[r].length!==t[r+1].length&&1!==t[r+1].length)throw new g("Unable to perform MultiplicativeInteraction: shapes can not be broadcasted.");for(var i=f(t[0]),o=1;o<t.length;o++)for(var a=0;a<i.length;a++)t[o].length>1?i[a]=i[a]*t[o][a]:i[a]=i[a]*t[o][0];return i}},{key:"dependencies",get:function(){return this.interactions}}]),o}(b),A=function(n){function o(n,t,r){var a;return e(this,o),(a=s(this,i(o).call(this,n))).input=t,a.value=r,a}return r(o,n),t(o,[{key:"transform",value:function(e){if(!(this.input in e))throw new g("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));var n=e[this.input];if(n.length!==this.value.length)return[0];for(var t=0;t<n.length;t++)if(n[t]!==this.value[t])return[0];return[1]}},{key:"dependencies",get:function(){return[this.input]}}]),o}(b),I=function(n){function o(n,t,r,a){var u;return e(this,o),(u=s(this,i(o).call(this,n))).input=t,u.min=r,u.max=a,u}return r(o,n),t(o,[{key:"transform",value:function(e){if(!(this.input in e))throw new g("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));for(var n=f(e[this.input]),t=0;t<n.length;t++)this.min&&n[t]<this.min?n[t]=this.min:this.max&&n[t]>this.max&&(n[t]=this.max);return n}},{key:"dependencies",get:function(){return[this.input]}}]),o}(b),O=function(n){function o(n,t,r,a){var u;return e(this,o),(u=s(this,i(o).call(this,n))).input=t,u.min=r,u.scale=a,u}return r(o,n),t(o,[{key:"transform",value:function(e){if(!(this.input in e))throw new g("Unable to transform feature '".concat(this.feature,"'. Missing required input '").concat(this.input,"'."));var n=e[this.input];if(n.length!==this.min.length||n.length!==this.scale.length)throw new g("Unable to transform feature '".concat(this.feature,"'. Shapes do not match."));for(var t=new Array(n.length),r=0;r<n.length;r++)t[r]=this.scale[r]*n[r]+this.min[r];return t}},{key:"dependencies",get:function(){return[this.input]}}]),o}(b);var C=function(){function n(t,r,i){e(this,n),this.name=t,this.transformer=r,this.index=i}return t(n,[{key:"dependencies",get:function(){return this.transformer.dependencies}}]),n}();function j(e){var n=e.features;return y(n),n.map((function(n,t){return e.model.features&&(t=e.model.features.indexOf(n.name)),new C(n.name,function(e){if(!e.transformation)return new b(e.name);if(e.transformation.type===w.MULTIPLICATIVE_INTERACTION)return new _(e.name,e.transformation.features);if(e.transformation.type===w.EQUALITY)return new A(e.name,e.transformation.input,e.transformation.value);if(e.transformation.type===w.CLIPPING)return new I(e.name,e.transformation.input,e.transformation.min,e.transformation.max);if(e.transformation.type===w.MINMAX_SCALING)return new O(e.name,e.transformation.input,e.transformation.min,e.transformation.scale);throw new d("Selected transformation (".concat(e.transformation.type,") is not supported."))}(n),t)}))}var S=function(e,n){return{get:function(t){var r={},i={};return n.forEach((function(o){-1!==o.index&&(r[o.name]=function t(r,i,o){if(o.hasOwnProperty(r.name))return o[r.name];if(1===r.dependencies.length&&r.dependencies[0]===r.name){var a=e.get(r.name,i);return Array.isArray(a)||(a=[a]),o[r.name]=a,o[r.name]=r.transformer.transform(o),o[r.name]}return r.dependencies.forEach((function(e){var a=n.find((function(n){return n.name===e}));if(!a)throw new m("Feature '".concat(r.name,"' is dependent on ").concat(e,", but this feature has not been defined!"));if(a.transformer.dependencies.includes(r.name))throw new m("IllegalDependency: Feature '".concat(r.name,"' is dependent on ").concat(e,"', but '").concat(e," is also dependent on '").concat(r.name,"'!"));t(a,i,o)})),o[r.name]=r.transformer.transform(o),o[r.name]}(o,t,i))})),r}}},P=Object.freeze({LOGISTIC_REGRESSION:"logistic_regression",PASSTHROUGH:"passthrough"});function k(e){if(!e.model_id)throw new d("Could not load model: missing required value model_id");if(!e.definition)throw new d("Could not load model: missing required definition");var n,t,r,i,o=JSON.parse(e.definition);if(!o.model)throw new d("Could not load model: missing required field 'model' in the model definition.");if(!o.features)throw new d("Could not load model: missing required feature definitions.");return o.model.type===P.PASSTHROUGH?(t=o,r=e.model_id,i=j(t),n=new E(r,i,t.version)):n=function(e,n){if(e.model.type!==P.LOGISTIC_REGRESSION)throw new d("Could not load model with unsupported type: ".concat(e.model.type));var t=j(e),r=function(e){if("logistic_regression"!==e.type)throw new d("Invalid model type: ".concat(e.type));if(!e.weights||!e.bias)throw new d("Received invalid model configuration");return new T(e.weights,e.bias)}(e.model);return new x(n,t,r,e.version)}(o,e.model_id),!n.version&&e.version&&(n.version=e.version),n}var T=function(e,n){if(!Array.isArray(e))throw new p("Weights must be provided as an Array.");if("number"!=typeof n)throw new p("Bias must be provided as a Number.");this.predict=function(t){if(!t instanceof Array)throw new m("FeatureProcessor must be provided as an Array.");var r=function(e){if("number"==typeof e)return v(e);y(e);for(var n=[],t=0;t<e.length;t++)n.push(v(e[t]));return n}(function(e,n){if(y(e),y(n),e.length!==n.length)throw new l("Vectors must have equal length (".concat(e.length," != ").concat(n.length,")"));for(var t=0,r=0;r<e.length;r++)t+=e[r]*n[r];return t}(t,e)+n);return[1-r,r]}},R=function(){function n(t,r,i){e(this,n),y(r),this.featureColumns=r,this.modelId=t,this.version=i}return t(n,[{key:"getFeatures",value:function(e,n){return new S(e,this.featureColumns).get(n)}},{key:"predict",value:function(e){throw new m("Not implemented")}}]),n}(),x=function(n){function o(n,t,r,a){var u;if(e(this,o),u=s(this,i(o).call(this,n,t,a)),!r instanceof T)throw new p("logisticRegression must be an instanceof LogisticRegression");return u.logisticRegression=r,u}return r(o,n),t(o,[{key:"predict",value:function(e){var n=[];return this.featureColumns.reduce((function(e,n){return-1!==n.index&&e.push(n),e}),[]).sort((function(e,n){return e.index-n.index})).forEach((function(t){if(!(t.name in e))throw new m("Missing required feature: ".concat(t.name));n=n.concat(e[t.name])})),this.logisticRegression.predict(n)[1]}}]),o}(R),E=function(n){function o(n,t,r){var a;return e(this,o),(a=s(this,i(o).call(this,n,t,r)))._passthroughFeatureColumn=null,a}return r(o,n),t(o,[{key:"getFeatures",value:function(e,n){var t,r,a,u;try{t=c(i(o.prototype),"getFeatures",this).call(this,e,n)}catch(e){var s=this.passthroughFeatureColumn;r={},a=s.name,u=[-1],a in r?Object.defineProperty(r,a,{value:u,enumerable:!0,configurable:!0,writable:!0}):r[a]=u,t=r}return t}},{key:"predict",value:function(e){var n=this.passthroughFeatureColumn;return n.name in e||(e[[n.name]]=[-1]),e[n.name][0]}},{key:"passthroughFeatureColumn",get:function(){if(null!==this._passthroughFeatureColumn)return this._passthroughFeatureColumn;var e=this.featureColumns.reduce((function(e,n){return-1!==n.index&&e.push(n),e}),[]).sort((function(e,n){return e.index-n.index}));if(e.length<1)throw new m("Could not determine passthrough feature column: model definition is invalid");if(e.length>1)throw new m("Could not determine passthrough feature column: multiple columns were provided");return this._passthroughFeatureColumn=e[0],this._passthroughFeatureColumn}}]),o}(R),q="inference",F=function(e){var n={};e.on("playlistItem",(function(){n.playSessionSequence||(n.playSessionSequence=0),n.playSessionSequence++})),e.on("nextAutoAdvance",(function(){n.advanceType="auto"})),e.on("feedAutoAdvance",(function(){n.advanceType="auto"})),e.on("nextClick",(function(){n.advanceType="click"})),e.on("feedClick",(function(){n.advanceType="click"})),this.getPlaySessionSequence=function(){return n.playSessionSequence||0},this.getAdvanceType=function(){return n.advanceType||null}},M={viewable:2},N=function(e,n,t){var r={is_player_viewable_at_inference_time:e.getViewable,is_player_viewable:e.getViewable,is_player_muted:e.getMute,play_session_sequence:n.getPlaySessionSequence,autostart:function(){var n=e.getConfig();return n.autostart in M?M[n.autostart]:n.autostart?1:0},advance_type:n.getAdvanceType};return{get:function(e,n){if(t.domain&&e in t.domain)return t.domain[e];if(n.metrics&&e in n.metrics)return n.metrics[e];if(!(e in r&&r[e]))throw new m("Unsupported measurement: ".concat(e));return r[e]()}}};(window.jwplayerPluginJsonp||window.jwplayer().registerPlugin)("inference","7.0",(function(e,n,t){var r,i,o,a,u=!1,s=new F(e);function c(){if(!u){if(!r||!i){if(!(i=e.getPlaylist())||"string"==typeof i)return void(u=!1);var n=e.getPlaylistItem();if(!n||!n.feedData)return;r=n.feedData||{}}if(r.jwpseg&&r.jwpseg.parameters){try{o=Object.keys(r.jwpseg.parameters).reduce((function(e,n){var t;return e[n]=(t=r.jwpseg.parameters[n],Array.isArray(t)?t.map(k):[k(t)]),e}),{})}catch(e){return console.warn("Failed to initialize the inference plugin: ".concat(e)),void f()}a=new N(e,s,r.jwpseg.metrics||{}),u=!0}else f()}}function f(){r=null,i=null,o=null,a=null,u=!1}function l(e,n,t){var r={processed:e.join(",")};return n&&n.jwpseg&&Array.isArray(n.jwpseg)&&(r.historicalApproved=n.jwpseg.join(",")),t&&(r.realTimeApproved=Object.keys(t).filter((function(e){return t[e]})).join(",")),r}return e.on("playlist",(function(e){f(),r=e.feedData,i=e.playlist,c()})),c(),{predict:function(n,t){if(!u)throw new m("The InferencePlugin has not been initialized.");var i=r.jwpseg.target_profiles;if(!i)throw new m("Feed did not contain targeting profiles!");var s={},c={};return n.forEach((function(n){var r=i[n];if(!r)throw new m("The segment ".concat(n," does not have any targeting criteria defined."));c[n]=Object.keys(r).every((function(n){if(n in s)return s[n].prediction>r[n];var i=function(n){var t,r=e.getConfig().__ab_inference||{};if(r.modelMap&&r.modelMap[n]){var i=r.modelMap[n];t=o[n].find((function(e){return e.modelId===i}))}else{var a=o[n]||[],u=a.map((function(e){return e.modelId}));u.sort((function(e,n){return e.localeCompare(n)})),t=a.find((function(e){return e.modelId===u[0]}))}if(!t)throw new m("Could not make predictions for target '".concat(n,"': no model available to support the request."));return t}(n),u=i.getFeatures(a,t),c=i.predict(u);return s[n]={modelVersion:i.version,prediction:c,modelId:i.modelId},s[n].prediction>r[n]}))})),e.trigger(q,{predictions:s,playlistItem:t,segments:l(n,t,c)}),c},version:"0.4.0"}}))}();
